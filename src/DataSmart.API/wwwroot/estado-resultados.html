<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataSmart Finance - Estado de Resultados</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2ecc71;
            --secondary-dark: #27ae60;
            --text-color: #2c3e50;
            --text-light: #7f8c8d;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

            .header h1 {
                font-size: 28px;
                margin-bottom: 10px;
            }

            .header p {
                opacity: 0.9;
                font-size: 16px;
            }

        .controls {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-label {
            font-size: 12px;
            color: var(--text-light);
            font-weight: 600;
        }

        select, button {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }

            button:hover {
                background: var(--primary-dark);
            }

        .table-container {
            overflow-x: auto;
            padding: 20px;
        }

        .financial-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

            .financial-table th,
            .financial-table td {
                padding: 12px;
                text-align: right;
                border-bottom: 1px solid var(--border-color);
            }

            .financial-table th {
                background: #f8fafc;
                font-weight: 600;
                color: var(--text-color);
                text-align: center;
                position: sticky;
                top: 0;
            }

                .financial-table td:first-child,
                .financial-table th:first-child {
                    text-align: left;
                    font-weight: 600;
                    background: #f8fafc;
                    position: sticky;
                    left: 0;
                    z-index: 2;
                }

            .financial-table .group-header {
                background: #e3f2fd;
                font-weight: 700;
                color: var(--primary-dark);
            }

            .financial-table .level-header {
                background: #f3e5f5;
                font-weight: 600;
                color: #7b1fa2;
            }

            .financial-table .account-row {
                background: white;
            }

            .financial-table .total-row {
                background: #e8f5e9;
                font-weight: 700;
                color: var(--secondary-dark);
            }

            .financial-table .negative {
                color: #c62828;
            }

            .financial-table .positive {
                color: #2e7d32;
            }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            text-align: center;
            margin: 20px;
            border-radius: 6px;
        }

        .kpi-section {
            padding: 20px;
            background: #f8fafc;
            border-top: 1px solid var(--border-color);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .kpi-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .kpi-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .kpi-label {
            font-size: 12px;
            color: var(--text-light);
            text-transform: uppercase;
        }

        .financial-table td:first-child {
            min-width: 250px;
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .financial-table td {
            min-width: 100px;
            padding: 8px 12px;
            font-size: 13px;
        }

        .loading {
            font-size: 16px;
        }

            .loading i {
                color: var(--primary-color);
            }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Estado de Resultados Anual</h1>
            <p>Análisis detallado de ingresos, costos y gastos</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <span class="control-label">Año</span>
                <select id="year-select">
                    <option value="">Cargando años...</option>
                </select>
            </div>

            <div class="control-group">
                <span class="control-label">Centro de Costos</span>
                <select id="cost-center-select">
                    <option value="all">Todos los centros</option>
                </select>
            </div>

            <div class="control-group">
                <span class="control-label">&nbsp;</span>
                <button id="refresh-btn">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin" style="font-size: 40px; margin-bottom: 15px;"></i>
            <p>Cargando datos del estado de resultados...</p>
        </div>

        <div id="error-message" class="error" style="display: none;"></div>

        <div class="table-container" style="display: none;" id="table-container">
            <table class="financial-table" id="financial-table">
                <thead>
                    <tr>
                        <th>Cuenta / Grupo</th>
                        <th>Enero</th>
                        <th>Febrero</th>
                        <th>Marzo</th>
                        <th>Abril</th>
                        <th>Mayo</th>
                        <th>Junio</th>
                        <th>Julio</th>
                        <th>Agosto</th>
                        <th>Septiembre</th>
                        <th>Octubre</th>
                        <th>Noviembre</th>
                        <th>Diciembre</th>
                        <th>Total Anual</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Los datos se insertarán aquí mediante JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="kpi-section" id="kpi-section" style="display: none;">
            <h3>Indicadores Clave (KPIs)</h3>
            <div class="kpi-grid" id="kpi-grid">
                <!-- Los KPIs se insertarán aquí -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const yearSelect = document.getElementById('year-select');
            const costCenterSelect = document.getElementById('cost-center-select');
            const refreshBtn = document.getElementById('refresh-btn');
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error-message');
            const tableContainer = document.getElementById('table-container');
            const tableBody = document.getElementById('table-body');
            const kpiSection = document.getElementById('kpi-section');
            const kpiGrid = document.getElementById('kpi-grid');

            let currentData = null;

            // Cargar años disponibles
            async function loadAvailableYears() {
                try {
                    showLoading();
                    const response = await fetch('/api/Finance/anios-disponibles');

                    if (response.ok) {
                        const years = await response.json();
                        yearSelect.innerHTML = '';

                        if (years && years.length > 0) {
                            years.forEach(year => {
                                const option = document.createElement('option');
                                option.value = year;
                                option.textContent = year;
                                yearSelect.appendChild(option);
                            });

                            // Cargar el primer año disponible
                            loadFinancialData(years[0]);
                        } else {
                            showError('No hay años disponibles. Sube un archivo primero.');
                        }
                    } else {
                        showError('Error cargando años disponibles: ' + response.status);
                    }
                } catch (error) {
                    showError('Error de conexión: ' + error.message);
                }
            }

            // Cargar datos financieros
            async function loadFinancialData(year) {
                try {
                    showLoading();
                    hideError();

                    console.log('Cargando datos para año:', year);
                    const response = await fetch(`/api/Finance/estado-resultados-anual?año=${year}`);

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Datos recibidos:', data);

                        currentData = data;
                        renderFinancialTable(data);
                        renderKPIs(data);
                        hideLoading();
                    } else {
                        const errorText = await response.text();
                        showError('Error cargando datos: ' + errorText);
                    }
                } catch (error) {
                    console.error('Error completo:', error);
                    showError('Error de conexión: ' + error.message);
                }
            }

            // Renderizar la tabla financiera (VERSIÓN SEGURA)
            function renderFinancialTable(data) {
                tableBody.innerHTML = '';

                if (!data || !data.estructura) {
                    showError('Estructura de datos no válida');
                    return;
                }

                // Verificar que tenemos meses definidos
                const meses = Array.from({ length: 12 }, (_, i) => i + 1);

                data.estructura.forEach(grupo => {
                    if (!grupo) return;

                    // Fila del grupo
                    addTableRow(
                        grupo.nombreGrupo || grupo.Grupo || 'Grupo sin nombre',
                        grupo.totalesPorMes || {},
                        grupo.totalAnualGrupo || 0,
                        'group-header'
                    );

                    // Niveles dentro del grupo (si existen)
                    if (grupo.niveles && Array.isArray(grupo.niveles)) {
                        grupo.niveles.forEach(nivel => {
                            if (!nivel) return;

                            addTableRow(
                                `↳ ${nivel.nivel || 'Nivel sin nombre'}`,
                                nivel.totalesPorMes || {},
                                nivel.totalAnualNivel || 0,
                                'level-header'
                            );

                            // Cuentas dentro del nivel (si existen)
                            if (nivel.cuentas && Array.isArray(nivel.cuentas)) {
                                nivel.cuentas.forEach(cuenta => {
                                    if (!cuenta) return;

                                    addTableRow(
                                        `↳ ↳ ${cuenta.nombreCuenta || cuenta.Cuenta || 'Cuenta sin nombre'}`,
                                        cuenta.totalesPorMes || {},
                                        cuenta.totalAnual || 0,
                                        'account-row'
                                    );
                                });
                            }
                        });
                    }

                    // Separador
                    addSeparatorRow();
                });

                tableContainer.style.display = 'block';
            }

            function addTableRow(label, monthlyData, annualTotal, rowClass) {
                const row = document.createElement('tr');
                row.className = rowClass;

                // Celda de label
                const labelCell = document.createElement('td');
                labelCell.textContent = label;
                labelCell.style.minWidth = '250px';
                row.appendChild(labelCell);

                // Celdas de meses (1-12)
                for (let mes = 1; mes <= 12; mes++) {
                    const cell = document.createElement('td');
                    const value = monthlyData[mes] || 0;
                    cell.textContent = formatCurrency(value);

                    if (value < 0) cell.classList.add('negative');
                    if (value > 0) cell.classList.add('positive');

                    row.appendChild(cell);
                }

                // Celda de total anual
                const totalCell = document.createElement('td');
                totalCell.textContent = formatCurrency(annualTotal);
                totalCell.style.fontWeight = '700';

                if (annualTotal < 0) totalCell.classList.add('negative');
                if (annualTotal > 0) totalCell.classList.add('positive');

                row.appendChild(totalCell);
                tableBody.appendChild(row);
            }

            function addSeparatorRow() {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 14;
                cell.style.height = '15px';
                cell.style.backgroundColor = '#f8fafc';
                cell.style.border = 'none';
                row.appendChild(cell);
                tableBody.appendChild(row);
            }

            // Renderizar KPIs (VERSIÓN SEGURA)
            function renderKPIs(data) {
                kpiGrid.innerHTML = '';

                if (data && data.kpis && typeof data.kpis === 'object') {
                    Object.entries(data.kpis).forEach(([key, value]) => {
                        const kpiCard = document.createElement('div');
                        kpiCard.className = 'kpi-card';

                        kpiCard.innerHTML = `
                                <div class="kpi-value">${typeof value === 'number' ? formatCurrency(value) : value}</div>
                                <div class="kpi-label">${formatKpiLabel(key)}</div>
                            `;

                        kpiGrid.appendChild(kpiCard);
                    });

                    kpiSection.style.display = 'block';
                } else {
                    kpiSection.style.display = 'none';
                }
            }

            function formatKpiLabel(key) {
                const labels = {
                    'MARGEN_BRUTO': 'Margen Bruto',
                    'MARGEN_BRUTO_%': 'Margen Bruto %',
                    'TOTAL_GASTOS_OPERACIONALES': 'Gastos Operacionales',
                    'TOTAL_INGRESOS_NO_OPERACIONALES': 'Ingresos No Operacionales'
                };

                return labels[key] || key.replace(/_/g, ' ');
            }

            function formatCurrency(value) {
                return new Intl.NumberFormat('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            }

            function showLoading() {
                loadingElement.style.display = 'block';
                tableContainer.style.display = 'none';
                kpiSection.style.display = 'none';
            }

            function hideLoading() {
                loadingElement.style.display = 'none';
            }

            function showError(message) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                hideLoading();
                console.error('Error:', message);
            }

            function hideError() {
                errorElement.style.display = 'none';
            }

            // Event listeners
            yearSelect.addEventListener('change', function () {
                if (this.value) {
                    loadFinancialData(this.value);
                }
            });

            refreshBtn.addEventListener('click', function () {
                if (yearSelect.value) {
                    loadFinancialData(yearSelect.value);
                }
            });

            // Inicializar
            loadAvailableYears();
        });
    </script>
</body>
</html>